%C ============================================================================
%C Módulo estilístico para libros técnicos
%C ============================================================================
%C Copyright (c) 2025 Andrés Conrado Montoya Acosta (github.com/conradolandia)
%C andi@sesentaycuatro.com | sesentaycuatro.com
%C Creado con ConTeXt LMTX (https://wiki.contextgarden.net/)
%C Versión: 0.1.4
%C Licencia: MIT
%C
%C Este módulo proporciona estilos y configuraciones para la composición de
%C libros técnicos en español, incluyendo:
%C - Configuración tipográfica con fuente Erewhon
%C - Layout optimizado para libros técnicos
%C - Elementos de contenido (tablas, figuras, listas)
%C - Páginas especiales (portada, legal, colofón)
%C - Gestión de autores y colaboradores
%C - Soporte para múltiples modos (PDF/A, imprenta, pantalla)
%C ============================================================================

\startmodule[libro-tecnico]

% ============================================================================
% CONFIGURACIÓN BÁSICA
% ============================================================================
% Configuración inicial del módulo, paths y modos de compilación

% Paths adicionales de búsqueda de archivos
\usepath[contenido]
\setupexternalfigures[directory={include,media,img},order={pdf,svg,png,jpg}]

% Modos de compilación
% Define modos especiales para diferentes tipos de salida
\definemode[pdfa][keep]      % PDF/A para archivo
\definemode[imprenta][keep]  % Modo imprenta con marcas de corte
\definemode[pantalla][keep]  % Modo pantalla (por defecto)

% ============================================================================
% CONFIGURACIÓN DE IDIOMA
% ============================================================================
% Configuración del español como idioma principal y reglas tipográficas

% Configura lenguaje de elementos de texto autogenerados como "Contenido"
\mainlanguage[es] 

% Cambia reglas de partición de palabras y reglas tipográficas 
% (comillas, espacio después de puntuaciones, etc.)
\language[es] 

% Configura mínimos de partición de palabras
\setuplanguage[es][hyphenmin=5] 

% Usar guiones existentes para partir palabras
\setbreakpoints[compound]

% Excepciones específicas de partición de palabras para términos técnicos
\hyphenation{ar-ticu-lar}
\hyphenation{ar-ticu-la}
\hyphenation{ar-ticu-la-res}
\hyphenation{re-ti-nacu-la-res}
\hyphenation{pro-ce-dimien-to}
\hyphenation{ex-tra-ar-ticu-la-res}
\hyphenation{ar-ticu-la-ción}
\hyphenation{ar-ticu-la-mien-to}
\hyphenation{com-par-timien-to}
\hyphenation{muscu-la-tura}
\hyphenation{ana-tómi-cos}
\hyphenation{or-tope-dia}

% ============================================================================
% SISTEMA DE COLORES
% ============================================================================
% Definición de colores base y semánticos para el documento

% Activar paleta de colores Crayola
\usecolors[crayola]

% Colores base
\definecolor[rojo][darkred]
\definecolor[negro][black]
\definecolor[blanco][white]
\definecolor[corregir][magenta]

% Escala de grises (de más claro a más oscuro)
\definecolor[casiblanco][s=0.98]        % Casi blanco
\definecolor[grismuymuyclaro][s=0.94]   % Gris muy muy claro
\definecolor[grismuyclaro][s=0.8]       % Gris muy claro
\definecolor[grisclaro][s=0.7]          % Gris claro
\definecolor[grismedio][s=0.5]          % Gris medio
\definecolor[grisoscuro][s=0.3]         % Gris oscuro
\definecolor[casinegro][s=0.03]         % Casi negro

% Highlights semánticos para uso en el texto
\definehighlight[rojo][color=rojo]
\definehighlight[negro][color=negro]
\definehighlight[blanco][color=blanco]
\definehighlight[casiblanco][color=casiblanco]
\definehighlight[grismuymuyclaro][color=grismuymuyclaro]
\definehighlight[grismuyclaro][color=grismuyclaro]
\definehighlight[grisclaro][color=grisclaro]
\definehighlight[grismedio][color=grismedio]
\definehighlight[grisoscuro][color=grisoscuro]
\definehighlight[casinegro][color=casinegro]
\definehighlight[corregir][color=corregir]

% Color de texto por defecto
\setupcolors[textcolor=negro]

% ============================================================================
% CONFIGURACIÓN TIPOGRÁFICA
% ============================================================================
% Configuración de fuentes, características tipográficas y espaciado

% Características de fuente por defecto
\definefontfeature[default][default][
    protrusion=punctuation,  % Protrusión de puntuación
    textitalics=yes,         % Itálicas automáticas
    case=yes,                % Soporte para mayúsculas/minúsculas
]

% Características para versalitas
\definefontfeature[smallcaps][smallcaps][
    cpsp=yes,                % Espaciado de versalitas
    c2sc=yes,                % Conversión a versalitas
]

% Números old-style y características matemáticas
\definefontfeature[osf][default][onum=yes]
\definefontfeature[mathextra][italicwidths=yes]

% Configuración de itálicas
\setupbodyfontenvironment[default][em=italic]
\setupitaliccorrection[global,always]

% Fuente principal: Erewhon
\loadtypescriptfile[erewhon]
\setupbodyfont[erewhon,11pt]

% Configuración general de alineación y capitales
\setupalign[hz,hanging,tolerant]
\setupcapitals[sc=yes]

% Espaciado y sangrías
\setupwhitespace[medium]
\setupindenting[no]

% Espacios horizontales predefinidos
\definehspace[dosem][2em]
\definehspace[tresem][3em]
\definehspace[doscm][2cm]
\definehspace[trescms][3cm]

% Interlineado (comentado por defecto)
%\setupinterlinespace[big]

% Comandos tipográficos especializados
% Versalitas con kerning
\define[1]\versalita{\start\feature[+][smallcaps]\kerncharacters[0.03]#1\stop}
% Números old-style
\define[1]\osf{\start\feature[+][osf]#1\stop}
% Números tabulares
\define[1]\tlf{\start\feature[+][tabularnumbers]#1\stop}
% Alias corto para \unhyphenated
\let\uhy\unhyphenated

% Highlights semánticos para énfasis
\definehighlight[emph][style={\em}]
\definehighlight[strong][style={\bf}]
\definehighlight[bemph][style={\bf\em}]

% Configuración de blockquotes
\setupdelimitedtext[blockquote][style={\switchtobodyfont[10pt]}]

% Comandos para ajuste de kerning
\define[1]\apretar{\kerncharacters[-0.01]{#1}}
\define[1]\apretarmas{\kerncharacters[-0.02]{#1}}
\define[1]\apretarmucho{\kerncharacters[-0.03]{#1}}

% ============================================================================
% HIPERVÍNCULOS Y NAVEGACIÓN
% ============================================================================
% Configuración de enlaces, marcadores y navegación del documento

% Activar hipervínculos
\setupinteraction[
  state=start,
  style={\tf},
  title={\getvariable{document}{title}},
  color=negro,
  contrastcolor=negro,
]

% Evitar que dos diagonales consecutivas se dividan en diferentes líneas
\enabledirectives[hyphenators.urls.packslashes] 

% Configurar partición de palabras en URLs
\sethyphenatedurlnormal{=?&}
\sethyphenatedurlbefore{}
\sethyphenatedurlafter{_:/;.,-}

% Configurar marcadores de libro: añadir marcadores para capítulo, sección y subsección
% pero solo abrir los capítulos por defecto en la estructura del PDF
\placebookmarks[chapter,section,subsection][chapter]
\setuptagging[state=start]

% ============================================================================
% CONFIGURACIÓN DE LAYOUT
% ============================================================================
% Configuración del tamaño de página, márgenes y distribución del contenido

% Configurar tamaño de página personalizado para libros técnicos
\definepapersize[libro][width=170mm,height=240mm]
\setuppapersize[libro][libro]

% Configurar tolerancia de espaciado
\setuptolerance[tolerant,stretch]

% Setup estricto para evitar viudas, huérfanos y malas particiones
\startsetups[estricto]
  \setdefaultpenalties
  \setpenalties\widowpenalties{2}{1000000}
  \setpenalties\clubpenalties {2}{1000000}
  \doublehyphendemerits=1000000
  \finalhyphendemerits=1000000
  \adjdemerits=30000
  \setbreakpoints[compound]
\stopsetups

% Configurar layout principal
\setuplayout[
  marking=off,
  topspace=5mm,
  height=634pt,
  backspace=30mm,
  width=120mm,
  header=10mm,
  footer=15mm,
  headerdistance=5mm,
  footerdistance=5mm,
  setups=layout:estricto,
]

% ============================================================================
% CONFIGURACIONES ESPECIALES POR MODO
% ============================================================================
% Configuraciones específicas para diferentes modos de compilación

% Configuración de backend para PDF/A
\startmode[pdfa]
  \setupbackend[
    format={pdf/a-1b:2005},
    profile={USWebCoatedSWOP.icc,AdobeRGB1998.icc,colo-imp-sgrey-v4.icc},
    intent={SWOP2006_Coated3v2.icc},
  ]
  \setupstructure[state=start,method=auto]
\stopmode

% Configuración para modo imprenta
% Con marcas de corte y montado en tamaño carta
\startmode[imprenta]
  \setuppapersize[libro][letter]
  \setuplayout[location=middle, marking=on]
  \setupbackend[
    format={PDF/X-4},
    profile={USWebCoatedSWOP.icc,AdobeRGB1998.icc,colo-imp-sgrey-v4.icc},
    intent={SWOP2006_Coated3v2.icc},
  ]
\stopmode

% ============================================================================
% ENCABEZADOS Y PIES DE PÁGINA
% ============================================================================
% Configuración de encabezados, pies de página y elementos de navegación

% Autores de capítulo
\def\AutorCapitulo{\dosingleempty\doAutorCapitulo}
\def\doAutorCapitulo[#1]#2{%
  \start\switchtobodyfont[10pt]%
  \doifsomethingelse{#1}
    {\emph{#2}\\\switchtobodyfont[8pt] #1}
    {\emph{#2}}
  \stop\par%
}

% Definir entorno para autores
\definestartstop[autores][before={\startalignment[flushright]}, after={\stopalignment}]

% Macro para números de capítulo terminados en punto
\def\chapterNumber#1{#1.}

% Capítulos no numerados pero que aparecen en la ToC
\definehead[sinnumerar][chapter]
\setuphead[sinnumerar][incrementnumber=list]

% Configuración general para seccionado
\setuphead[
  section,subsection,
  subsubsection,
  subsubsubsection,
  subsubsubsubsection,
][number=no,align={flushleft,nothyphenated,verytolerant,stretch}]

% Estilos de capítulo y secciones
\startsetups[chapter:before]
  \page
  \doifoddpageelse
    {}
    {\page[yes,header,footer,right]}
\stopsetups

\startsetups[chapter:after]
  \blank[line]
  \startautores
    \AutorCapitulo[\structureuservariable{afiliacion}]
      {\commalistsentence[\structureuservariable{autores}][{,\space},{\space y~}]}
  \stopautores
  \blank[6*line]
\stopsetups

% Makeup para partes
\definemakeup[part][align=middle,pagestate=start]

% ============================================================================
% CONFIGURACIÓN DE CABECERAS Y SECCIONES
% ============================================================================
% Estilos y configuraciones para todos los niveles de seccionado

% Configuración de partes
\setuphead[part][
  placehead=yes,
  beforesection=\directsetup{chapter:before},
  number=no,
  align={flushright,nothyphenated,verytolerant},
  style={\bfd},
  deeptextcommand={\versalita},
  header=empty,
  before=\startpartmakeup,
  after=\stoppartmakeup,
]

% Configuración de capítulos
\setuphead[chapter][
  align={flushright,nothyphenated,verytolerant},
  beforesection=\directsetup{chapter:before},
  number=yes,
  style=\bfb,
  header=empty,
  deepnumbercommand={\chapterNumber},
  after=\directsetup{chapter:after},
]

% Configuración de capítulos sin numerar y títulos
\setuphead[sinnumerar,title][after={\blank[8*line]}]

% Configuración de secciones
\setuphead[section][style={\bfa}]
\setuphead[subsection][style=boldslanted]
\setuphead[subsubsection][style=,deeptextcommand={\versalita}]
\setuphead[subsubsubsection][style=slanted]
\setuphead[subsubsubsubsection][style=italic]

% Configuración de numeración de páginas
\setuppagenumbering[alternative=doublesided,location=]

% ============================================================================
% CONFIGURACIÓN DE PIES DE PÁGINA
% ============================================================================
% Configuración de pies de página con información del documento y navegación

% Definir marco para pies de página
\defineframed[footers][
  frame=off,
  roffset=4pt,
  loffset=4pt,
  toffset=0pt,
  boffset=0pt,
  strut=global,
  height=12pt,
  width=fit,
]

% Definir contenido de pies de página
\define\lfoot{%
  {%
    \footers[rightframe=on,loffset=-4pt,roffset=3pt]{%
      \small\osf{\pagenumber}%
    }%
  }%
  {%
    \expanded{%
      \footers[leftframe=on]{%
        \small\grisoscuro{\documentvariable{titulo}}%
      }%
    }%
  }%
}
\define\rfoot{%
  {%
    \expanded{%
      \footers[rightframe=on]{%
        \small\grisoscuro{\getmarking[chapter]}%
      }%
    }%
  }%
  {%
    \footers[leftframe=on,loffset=2pt,roffset=-2pt]{%
      \small\osf{\pagenumber}%
    }%
  }%
}

% Activar configuraciones generales de encabezados y pies
\setupheadertexts[][][][]
\setupfootertexts[][\rfoot][\lfoot][]

% Configuración de pies de página para frontpart (sin pies)
\startsectionblockenvironment[frontpart]
  \setupfootertexts[][][][]
\stopsectionblockenvironment

% ============================================================================
% ELEMENTOS DE CONTENIDO
% ============================================================================
% Configuración de listas, descripciones, notas al pie y bibliografía

% Macro para encabezados de descripciones
\define[1]\termino{#1~}

% Configuración de descripciones
\definedescription[description][
  headstyle=bold,
  style=normal,
  width=broad,
  distance=none,
  alternative=hanging,
  headcommand={\termino},
  margin=2em,
]

% Configuración de listas con viñetas
\setupitemize[itemalign=left,distance=.5em]

% Macro para números de notas al pie
\define[1]\FNo{{\osf{#1}.}}

% Configuración de notas al pie
\setupnote
   [footnote]
   [width=\textwidth]

% Configuración de anotaciones al pie de página
\setupnotation[footnote]
   [align={flushleft,nothyphenated,verytolerant},
   numbercommand=\FNo]

% Configuración de listas enumeradas
\defineitemgroup[enumerate]
\setupenumerate[each][fit][itemalign=left,distance=.5em,style={\feature[+][default:tnum]}]

% Configuración de bibliografía manual
\defineitemgroup[bibliografia]
\setupbibliografia[each][n,loose][symalign={left},distance={0.5em},align={right,nothyphenated},left={[},right={]},stopper=,inbetween={\blank[0.5em]}]

% ============================================================================
% TABLA DE CONTENIDO Y LISTAS
% ============================================================================
% Configuración de tabla de contenido, listas de figuras y tablas

% Añadir autores de capítulo a la lista TOC
% Se agregan autores como un par adicional de corchetes en el título, ejemplo:
% \startchapter[title={Something}][autores={{Rauno Seitseminen, MD},{Micke Stronberg, MD},{Uma Öst, MD}}]
\newdimen\ChapterEntryWidth
\ChapterEntryWidth=16pt
\define[1]\SectionTocEntry{%
  #1\doifsomething{\rawstructurelistuservariable{autores}}{%
    \crlf
    \start
      \setupalign[flushleft,nothyphenated,verytolerant]
      \switchtobodyfont[9pt]
      \hskip\ChapterEntryWidth
      \commalistsentence[\rawstructurelistuservariable{autores}][{,\space},{\space y~}]
    \stop%
  }
}

% Configurar que incluir en la tabla de contenido
\setupcombinedlist[content][list={chapter,sinnumerar},alternative=c]

% Configuración de aspecto de secciones en tabla de contenido
\setuplist[part][textstyle={bold},textcommand={\versalita},before={\blank[2*big]},after={\blank[2*big]}]
\setuplist[chapter][after=\SectionTocEntry,stopper={.},width={\ChapterEntryWidth}]

% Crear lista de figuras que contenga figure, rightfigure y leftfigure
\definecombinedlist[figuras][figure,rightfigure,leftfigure][alternative=c]

% Crear lista de tablas que contenga table, righttable y lefttable
\definecombinedlist[tablas][table,righttable,lefttable][alternative=c]

% ============================================================================
% MARCOS Y ELEMENTOS VISUALES
% ============================================================================
% Configuración de marcos, cajas y elementos decorativos

% Configuración general de marcos de texto
\setupframedtexts[
  width={\makeupwidth},
  background=color,
  backgroundcolor=grismuymuyclaro,
  width=local,
  framecolor=grisoscuro,
  foregroundcolor=casinegro,
  foregroundstyle=small,
  rulethickness=1pt,
  frameoffset=0.3em,
  backgroundoffset=0.3em,
]

% Marco lateral con borde izquierdo
\defineframed[lateral][
  frame=off,
  leftframe=on,
  framecolor=grisoscuro,
  foreground=color,
  foregroundcolor=grismuymuyclaro,
  rulethickness=2pt,
  frameoffset=10pt,
]

% Marco para páginas legales
\defineframed[legal][
  frame=off,
  strut=yes,
  align={table},
  width=.45\textwidth,
  location=depth,
  setups={document:legal},
]

% ============================================================================
% FLOTANTES Y FIGURAS
% ============================================================================
% Configuración de figuras, tablas y elementos flotantes

% Separación de flotantes
\setuplabeltext[es][continued={ (continuación)}]
\setupfloatsplitting[conversion=continued]

% Configuración de logotipos
\defineexternalfigure[logotipo][maxwidth=.4\textwidth]

% Ubicación por defecto de flotantes
\setupfloat[figure,table][default={here},location={center,max}]

% Configuración de títulos de flotantes
\setupcaptions[
  style={\small},
  width=max,
  prefix=yes,
  way=bychapter,
  prefixsegments=chapter,
  headstyle={\tf},
  suffixseparator={.},
  distance={.5em},
  align={middle,nothyphenated,verytolerant,stretch},
  inbetween={\blank[big]},
]

% Configuración de títulos de tablas
\setupcaption[table][location=top]

% Figuras a la izquierda
\definefloat[leftfigure][leftfigures][figure]
\setupcaption[leftfigure][
  location={left,middle},
  distance={1em},
  headseparator={.\hskip-0.5em},
  align={left,nothyphenated,verytolerant,stretch},
]

% Tablas a la izquierda
\definefloat[lefttable][lefttables][table]
\setupcaption[lefttable][
  location={left,middle},
  distance={1em},
  headseparator={.\hskip-0.5em},
  align={left,nothyphenated,verytolerant,stretch},
]

% Figuras a la derecha
\definefloat[rightfigure][rightfigures][figure]
\setupcaption[rightfigure][
  location={right,middle},
  distance={1em},
  headseparator={.\hskip-0.5em},
  align={right,nothyphenated,verytolerant,stretch},
]

% Tablas a la derecha
\definefloat[righttable][righttables][table]
\setupcaption[righttable][
  location={right,middle},
  distance={1em},
  headseparator={.\hskip-0.5em},
  align={right,nothyphenated,verytolerant,stretch},
]

% Autores
\definefloat[autor][autores][figure]
\setupfloat[autor][sidealign=line]
\setupcaption[autor][location=none]
\defineexternalfigure[autor][width=2cm]

% Formatos de referencia
\definereferenceformat[figura][text={figura~}]
\definereferenceformat[tabla][text={tabla~}]
\definereferenceformat[simple][text={}]

% ============================================================================
% CONFIGURACIÓN DE TABLAS
% ============================================================================
% Configuración de tablas con xtables y TABLE

% Configuración de xtables
\setupxtable[
  frame=off,
  rulethickness=0.2pt,
  framecolor=grismedio,
  option=stretch,
  bodyfont=small,
  foregroundstyle={\tabular},
]

\setupxtable[head][topframe=on,bottomframe=on,foregroundstyle=bold]
\setupxtable[body][bottomframe=on]
\setupxtable[foot][bottomframe=on]

% Tabla simple sin marcos
\definextable[simple]
\setupxtable[simple][frame=off,topframe=off,bottomframe=off]

% Configuración de TABLE
\setupTABLE[frame=off,style=small]
\setupTABLE[row][topframe=on,bottomframe=on,style=small,rulethickness=0.3pt]
\setupTABLE[row][1][style={\small\bf},rulethickness=0.6pt]
\setupTABLE[row][last][bottomframe=on]

% ============================================================================
% AUTORÍA PARA TABLAS Y FIGURAS
% ============================================================================
% Comandos para especificar fuentes y autoría de elementos gráficos

% Comandos para fuentes de figuras/tablas (sin "Fuente:")
\define[1]\fuentent{\start\setupalign[middle,nothyphenated,verytolerant,stretch]\switchtobodyfont[8pt]#1\stop}
\define[1]\xfuentent{\start\setupalign[middle,nothyphenated,verytolerant,stretch]#1\stop}
\define[1]\fuentefignt{\par\blank[2pt]\start\switchtobodyfont[8pt]#1\stop}

% Comandos para fuentes de figuras/tablas (con "Fuente:")
\define[1]\fuente{\startframed[strut=no,frame=off,align=middle,width=max]\switchtobodyfont[8pt]\emph{Fuente:}~#1\stopframed}
\define[1]\xfuente{\start\setupalign[middle,nothyphenated,verytolerant,stretch]\emph{Fuente:}~#1\stop}
\define[1]\fuentefig{\par\blank[2pt]\start\switchtobodyfont[8pt]\emph{Fuente:}~#1\stop}

% Comandos predefinidos para elaboración propia
\define\propia{\fuentefig{elaboración propia.}}
\define\propiat{\fuente{elaboración propia.}}

% ============================================================================
% MAKEUPS Y PÁGINAS ESPECIALES
% ============================================================================
% Configuración de layouts y makeups para páginas especiales del libro

% Layout y makeup para antetítulo
\definelayout [antetitulo][topspace=0.5in]

\definemakeup [antetitulo][
  align={flushright,nothyphenated,verytolerant},
  doublesided=no,
  page=right,
  top=,
  headerstate=empty,
  footerstate=empty,
  pagestate=start,
]

% Layout y makeup para portadilla
\definelayout [portadilla][
  header=\zeropoint,
  footer=\zeropoint,
  topspace=1in,
]

\definemakeup [portadilla][
  align={flushright,nothyphenated,verytolerant},
  doublesided=no,
  page=right,
  headerstate=empty,
  footerstate=empty,
  pagestate=start,
]

% Layout y makeup para páginas legales
\definelayout [legal][header=3.5cm]

\definemakeup [legal][
  doublesided=no,
  page=left,
  top=,
  bottom=,
  pagestate=start,
]

% Makeup para colofón
\definelayout [colofon][
  width=17cm,
  height=24cm,
  backspace=\zeropoint,
  topspace=\zeropoint,
  header=\zeropoint,
  footer=\zeropoint,
]

\definemakeup [colofon][
  align=center,
  doublesided=empty,
  headerstate=empty,
  footerstate=empty,
  page=left,
]

% Makeup para dedicatoria
\definemakeup [dedicatoria][
  align={flushright,nothyphenated,verytolerant},
  doublesided=no,
  page=right,
  style={\italic},
  headerstate=empty,
  footerstate=empty,
  pagestate=start,
]

% ============================================================================
% GESTIÓN DE AUTORES Y COLABORADORES
% ============================================================================
% Namespaces y comandos para manejo de información de autores y colaboradores

% Registro de colaboradores
\definenamespace[colaboradores][
  type=module,
  name=colaborador,
  command=yes,
  parent=colaboradores,
]

% Registro de autores
\definenamespace[autores][
  type=module,
  name=autor,
  command=yes,
  parent=autores,
]

% Presentar los colaboradores con rol (página legal)
\define[1]\Colaborador{\edef\currentcolaborador{#1}{%
  \doifsomething{\colaboradorparameter{rol}}{\colaboradorparameter{rol}:\crlf}%
  \doifsomething{\colaboradorparameter{nombre}}{\colaboradorparameter{nombre}\blank[halfline]\endgraf}%
}}

% Presentar nombre de colaborador (impresor, otros)
\define[1]\NombreColaborador{\edef\currentcolaborador{#1}{%
  \doifsomething{\colaboradorparameter{nombre}}{\colaboradorparameter{nombre}}%
}}

% Definición para mostrar nombre completo de autor
\starttexdefinition AutorNombreApellido #1
    \edef\currentautor{#1}%
    \unless\ifempty{\autorparameter{nombres}}
        \autorparameter{nombres}
        \space
    \fi
    \unless\ifempty{\autorparameter{apellidos}}
        \autorparameter{apellidos}
    \fi
\stoptexdefinition

% Definición para lista horizontal de autores
\starttexdefinition AutorEnListaH #1
     \advance\scratchcountertwo\plusone
     \ifnum\scratchcountertwo=\plusone
         % nothing
     \orelse\ifnum\scratchcountertwo=\scratchcounterone
         \space{y}\space
     \else
         ,\space
     \fi
     \AutorNombreApellido{#1}%
\stoptexdefinition

\starttexdefinition AutoresListaH #1
     \getcommacommandsize[#1]%
     \scratchcounterone\commalistsize
     \scratchcountertwo\zerocount
     \processcommacommand[#1]\AutorEnListaH
\stoptexdefinition

% Definición para lista vertical de autores
\starttexdefinition AutorEnListaV #1
     \AutorNombreApellido{#1}\par
\stoptexdefinition

\starttexdefinition AutoresListaV #1
     \processcommacommand[#1]\AutorEnListaV
\stoptexdefinition

% ============================================================================
% BUFFERS Y CONTENIDO PREDEFINIDO
% ============================================================================
% Buffers con contenido predefinido para páginas especiales

% Buffer para información editorial
\startbuffer[editorial]
  \documentvariable{editorial}\\
  \documentvariable{editorialDireccion}
  Teléfono:~\documentvariable{editorialTelefono} \\
  \texthref{\documentvariable{editorialUrl}}{https://\documentvariable{editorialUrl}/}\\
  \texthref{\documentvariable{editorialEmail}}{mailto:\documentvariable{editorialEmail}}
\stopbuffer

% Buffer para página legal izquierda
\startbuffer[legalizquierda]
  Reservados todos los derechos\\
  ©~\documentvariable{copyright}\\
  ©~\AutoresListaH{\documentvariable{autores}},\space\documentvariable{roles}\\
  ©~Varios autores
  \blank[big]
  \Word{\documentvariable{edicion}}~edición: \documentvariable{fecha}\\
  \versalita{isbn:} (impreso) {\documentvariable{isbn}}\\
  \versalita{isbn:} (digital) {\documentvariable{isbne}}\\
  \versalita{doi:} {\DOIurl}
  \blank[halfline]
  Número de ejemplares: \documentvariable{ejemplares}
  \blank[halfline]
  Impreso y hecho en Colombia\\
  \emph{Printed and made in Colombia}
  \blank[big]
  \getbuffer[editorial]
\stopbuffer

% Buffer para página legal derecha
\startbuffer[legalderecha]
  \processcommacommand[\documentvariable{colaboradores}]\Colaborador
  \blank[2*big]
    \documentvariable{reconocimiento}
\stopbuffer

% Buffer para ficha catalográfica
\startbuffer[catalografica]
  \start
    \setupalign[middle,nothyphenated,verytolerant]
    \documentvariable{institucion}.\space\documentvariable{biblioteca}\\
    Catalogación en la publicación\par
  \stop
  \blank[big]
  \startparagraph
    \AutoresListaH{\documentvariable{autores}}, \commalistsentence[\documentvariable{roles}]
  \stopparagraph
  \startparagraph
    \documentvariable{catalografica}
  \stopparagraph
  \blank[big]
  \totalnumberofpages~páginas~; ilustraciones, Fotografías~; 17~×~24\,cm.\par
  \versalita{ISBN}: \documentvariable{isbn} (impreso)\par
  \versalita{ISBN}: \documentvariable{isbne} (electrónico)\par
  \blank[big]
  \documentvariable{tematicas}
  \blank[big]
  CDD~\documentvariable{CDD} edición \documentvariable{CDDEdicion}\crlf
  \thinrule
  \blank[small]
  inp \hfill \documentvariable{inp}
\stopbuffer

% Buffer para colofón
\startbuffer[colofon]
  Este libro se compuso\\
  usando tipos Erewhon, \\
  con el sistema de composición \\
  tipográﬁca \CONTEXTLINK. \\
  Se terminó de imprimir \\
  en los talleres de \NombreColaborador{\documentvariable{impresores}} \\
  en \documentvariable{fecha}.
\stopbuffer

% ============================================================================
% SETUPS DE DOCUMENTO
% ============================================================================
% Configuraciones automáticas para inicio y fin del documento

% Setup para páginas legales
\startsetups[document:legal]
  \switchtobodyfont[8pt]
\stopsetups

% Setup para inicio del documento
\startsetups[document:start]
  \startmakeup[antetitulo]
    \start\bf\raggedleft\dontleavehmode\switchtobodyfont[14pt]\documentvariable{titulo}\\\switchtobodyfont[11pt]\documentvariable{subtitulo}\stop
  \stopmakeup

  \page[yes,empty,right]

  \startmakeup[portadilla]
    \start
      \bf\switchtobodyfont[32pt]\documentvariable{titulo}\blank[small]
      \switchtobodyfont[12pt]\grisoscuro{\documentvariable{subtitulo}}
    \stop
    \blank[3cm]
    \start
      \switchtobodyfont[12pt]
      \grismedio{\versalita{\AutoresListaV{\documentvariable{autores}}}}
      \small\grisoscuro\Word{\documentvariable{roles}}
    \stop
    \blank[9cm]
    \dontleavehmode\externalfigure[\documentvariable{logotipoinstitucion}][logotipo]
  \stopmakeup

  \startmakeup[legal]
    \vfill
    \startcombination[2*1]
      {\legal{\externalfigure[\documentvariable{logotipofacultad}][height=1.2cm]}}{}
      {\legal{\externalfigure[\documentvariable{logotipoeditorial}][height=1cm]}}{}
    \stopcombination
    \blank[medium]
    \startcombination[nx=2,ny=1,location={top}]
      {\legal{\getbuffer[legalizquierda]}}{}
      {\legal{\getbuffer[legalderecha]}}{}
    \stopcombination
    \blank[2*big]
    \startframed[offset=1em,width=local,align={width,nothyphenated,verytolerant}]
      \switchtobodyfont[7pt]
      \getbuffer[catalografica]
    \stopframed
  \stopmakeup
\stopsetups

% Setup para fin del documento
\startsetups[document:stop]
  \doifoddpageelse{}{\page[yes,header,footer,left]}
  \startmakeup[colofon]
      \getbuffer[colofon]
  \stopmakeup
\stopsetups

% ============================================================================
% MACROS ADICIONALES Y FILTROS
% ============================================================================
% Comandos auxiliares y filtros externos para funcionalidad extendida

% ConTeXt logo con enlace
\define\CONTEXTLINK{\texthref{\CONTEXT}{https://context.aanhet.net/}}

% Macros para hyperlinks
\define[1]\href{\bgroup\startasciimode\goto{\hyphenatedurl{#1}}[url(#1)]\stopasciimode\egroup}
\define[2]\texthref{\bgroup\startasciimode\goto{#1}[url(#2)]\stopasciimode\egroup}

% Generación de DOI
\define\DOIurl{\href{https://doi.org/10.11144/Javeriana.\documentvariable{doi}}}

% Macros para acomodar líneas extra
\define\unamas{\adaptlayout[lines=+1]}
\define\dosmas{\adaptlayout[lines=+2]}

% Filtros externos
\usemodule[filter]

% Markdown: introducir código markdown directamente entre \startmarkdown..\stopmarkdown
\defineexternalfilter[markdown]
  [filtercommand={pandoc -t context -f markdown -o \externalfilteroutputfile\space\externalfilterinputfile}]

\stopmodule
\endinput
